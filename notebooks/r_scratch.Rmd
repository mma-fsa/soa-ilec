---
title: "Untitled"
author: "Mike McPhee Anderson, FSA"
date: "2025-10-11"
output: html_document
---

```{r setup, include=FALSE}

library(DBI)
library(duckdb)
library(rpart)
library(tidyverse)

AGENT_LIB = "~/workspace/soa-ilec/soa-ilec/mcp/ilec_r_lib.R"
AGENT_WS_DIR = "/home/mike/workspace/soa-ilec/soa-ilec/mcp_agent_work/session_abcedfg"

```

## Setup work dir

```{r}

system(paste0("rm -rf ", AGENT_WS_DIR))
system(paste0("mkdir -p ", AGENT_WS_DIR))

```

## Setup database connection

```{r}

pq_path <- "/home/mike/workspace/soa-ilec/soa-ilec/data/ilec_2009_19_20210528.parquet"

if (!exists("conn")) {
  conn <- DBI::dbConnect(duckdb::duckdb(), paste0(AGENT_WS_DIR, "/model_data.duckdb"))
  DBI::dbExecute(conn, "set memory_limit='4GB'")
}

tbl_ilec_data <- tbl(
  conn, 
  sprintf("read_parquet('%s')", pq_path)) %>%
  mutate(
    Smoker_Status = case_when(
      coalesce(Smoker_Status, "UNKNOWN") == "UNKNOWN" ~ "Unismoke",
      TRUE ~ Smoker_Status
    )
  )

DBI::dbExecute(
  conn,
  sprintf("create or replace view ILEC_DATA as (%s)", dbplyr::sql_render(tbl_ilec_data))
)

```


## Test Agent Functionality

```{r}
source(AGENT_LIB)
setwd(AGENT_WS_DIR)

cmd_create_dataset(conn, "training_data", "select * from ILEC_DATA where Observation_Year <= 2016")
cmd_create_dataset(conn, "testing_data", "select * from ILEC_DATA where Observation_Year > 2016")

```

## test rpart

```{r}

source(AGENT_LIB)
setwd(AGENT_WS_DIR)

x_vars <- c("Gender", "Insurance_Plan", "Smoker_Status", "Issue_Year")

# cmd_rpart <- function(x_vars, offset, y_var, max_depth, cp)
cmd_rpart(conn, "training_data", x_vars, "Expected_Death_QX2015VBT_by_Policy", "Number_Of_Deaths", 3, 0.001)


```



## Setup Connection

```{r}


pq_path <- "/home/mike/workspace/soa-ilec/soa-ilec/data/ilec_2009_19_20210528.parquet"

tbl_ilec_data <- tbl(
  conn, 
  sprintf("read_parquet('%s')", pq_path))

head(tbl_ilec_data)

```

```{r}

tbl_ilec_data %>%
  summarise(
    max(Observation_Year)
  )

```


```{r}

df_results <- tbl_ilec_data %>%
  mutate(
    Smoker_Status = case_when(
      coalesce(Smoker_Status, "UNKNOWN") == "UNKNOWN" ~ "Unismoke",
      TRUE ~ Smoker_Status
    )
  ) %>%
  group_by(Gender, Insurance_Plan, Smoker_Status, Issue_Year) %>%
  summarise(
    Number_Of_Deaths = sum(Number_Of_Deaths),
    Expected_Deaths = sum(ExpDeathQx2015VBTwMI_byPol),
    .groups="drop"
  ) %>%
  collect()

```

## Test Agent Commands

```{r}

x_vars <- c("Gender", "Insurance_Plan", "Smoker_Status", "Issue_Year")
df_model_data <- df_results

# cmd_rpart <- function(x_vars, offset, y_var, max_depth, cp)
cmd_rpart("df_model_data", x_vars, "Expected_Deaths", "Number_Of_Deaths", 3, 0.001)

```



```{r}

source(AGENT_LIB)

df_model_data <- df_results %>%
  mutate(
    Smoker_Status = case_when(
      coalesce(Smoker_Status, "UNKNOWN") == "UNKNOWN" ~ "Unismoke",
      TRUE ~ Smoker_Status
    )
  )
  
df_model_data.train <- df_model_data
df_model_data.test <- df_model_data

x_vars <- c("Gender", "Insurance_Plan", "Smoker_Status", "Issue_Year")
design_matrix_vars <- c(
  "Gender:Insurance_Plan",
  "Issue_Year",
  "Gender*Smoker_Status"
)

colnames(df_model_data)


unique(df_model_data$Smoker_Status)

cmd_glmnet(
  x_vars,
  design_matrix_vars,
  list(
    "Gender" = "Male",
    "Smoker_Status" = "NonSmoker"
  ),
  list(
    "Issue_Year" = c(1980, 2022)
  ),
  "Expected_Deaths",
  "Number_Of_Deaths",
  "1se"
)

```


## Rpart stuff

```{r}

fit_rpart <- rpart(as.matrix(df_results[, c("Expected_Deaths", c("Number_Of_Deaths"))]) ~ Gender + Insurance_Plan, data=df_results, method="poisson",
                   control=rpart.control(cp=0.001, max_depth=5))

```



```{r}

print(fit_rpart)

```

```{r}

# simple_print_rpart.R
simple_print_rpart <- function(x, digits = 4, max_leaves = Inf, show_call = TRUE) {
  stopifnot(inherits(x, "rpart"))
  fr <- x$frame
  leaves_idx <- which(fr$var == "<leaf>")
  leaves <- rownames(fr)[leaves_idx]
  if (!is.infinite(max_leaves)) {
    leaves <- head(leaves, max_leaves)
  }

  # Header
  if (show_call && !is.null(x$call)) {
    cat("Call:\n")
    print(x$call)
  }
  method <- x$method
  nobs   <- sum(fr$n[rownames(fr) == "1"]) # root n (or just max fr$n if you prefer)
  nleaves <- sum(fr$var == "<leaf>")
  depth <- max(lengths(path.rpart(x, nodes = as.numeric(rownames(fr))))) - 1L

  cat(sprintf(
    "\nMethod: %s | Observations: %s | Leaves: %s | Max depth: %s\n",
    method, nobs, nleaves, depth
  ))
  if (!is.null(x$terms)) {
    cat("Response:", deparse(attr(x$terms, "response")), "\n")
  }

  # Print leaves with their paths
  cat("\nLeaves:\n")
  leaf_nodes <- as.numeric(leaves)
  paths <- path.rpart(x, nodes = leaf_nodes)

  for (i in seq_along(leaf_nodes)) {
    node <- leaf_nodes[i]
    p <- paths[[i]]
    # Drop the first element ("root")
    cond <- if (length(p) > 1) paste(p[-1], collapse = " & ") else "<root>"
    yi   <- fr$yval[match(node, as.numeric(rownames(fr)))]
    ni   <- fr$n   [match(node, as.numeric(rownames(fr)))]
    devi <- fr$dev [match(node, as.numeric(rownames(fr)))]

    cat(sprintf("  Node %s: %s\n", node, cond))
    cat(sprintf("    -> y = %s, n = %s, dev = %s\n",
                signif(yi, digits), ni, signif(devi, digits)))
  }

  invisible(x)
}

simple_print_rpart(fit_rpart)

```

```{r}

df_data <- tbl_ilec_data %>%
  filter(Insurance_Plan == "UL") %>%
  group_by(
    Gender,
    Smoker_Status, 
    Issue_Age, 
    Duration, 
    Face_Amount_Band, 
    Preferred_Indicator, 
    Preferred_Class, 
    Select_Ultimate_Indicator, 
    Issue_Year 
  ) %>%
  summarise(
    EXPECTED_EVENTS = sum(coalesce(ExpDeathQx2015VBTwMI_byPol, 0)),
    ACTUAL_EVENTS = sum(coalesce(Number_Of_Deaths, 0)),
    .groups="drop"
  ) %>%
  collect()

sum(df_data$EXPECTED_EVENTS)

```

```{r}

df_data %>%
  filter(ACTUAL_EVENTS > 0, EXPECTED_EVENTS == 0) %>%
  head()

```




```{r}

df_data %>%
  filter(EXPECTED_EVENTS == 0) %>%
  nrow()

```



