{% extends "layout.html" %}
{% block title %}Query · ILEC{% endblock %}

{% block head %}
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@codemirror/theme-one-dark@6.2.0/theme-one-dark.css" />
  <style>
    .split-wrap {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    @media (min-width: 992px) {
      .split-wrap { flex-direction: row; }
      .editor-pane { flex: 0 0 40%; max-width: 40%; }
      .results-pane { flex: 0 0 60%; max-width: 60%; }
    }
    .card-fill { height: 72vh; display: flex; flex-direction: column; }
    .cm-editor {
      border: 1px solid #ced4da;
      border-radius: .375rem;
      font-size: .75rem;
      height: 100%;
    }
    .editor-shell { flex: 1; min-height: 300px; }
    .results-body { overflow: auto; flex: 1; min-height: 300px; }
    .results-meta {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: .75rem;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="split-wrap">
    <div class="editor-pane">
      <div class="card shadow-sm card-fill">
        <div class="card-body d-flex flex-column">
          <h1 class="h5 mb-3">Run SQL on <code>ILEC_DATA</code></h1>
          <textarea id="query" hidden>SELECT * FROM ILEC_DATA LIMIT 5;</textarea>
          <div class="editor-shell"><div id="editor"></div></div>
          <div class="d-flex align-items-center gap-2 mt-3">
            <button id="run-btn" class="btn btn-primary">Run Query</button>
            <button id="format-btn" class="btn btn-outline-secondary">Format</button>
            <span class="text-muted ms-auto small">Only <code>SELECT ... FROM ILEC_DATA</code> is allowed.</span>
          </div>
        </div>
      </div>
    </div>

    <div class="results-pane">
      <div class="card shadow-sm card-fill">
        <div class="card-body d-flex flex-column">
          <div class="results-meta">
            <h2 class="h6 m-0">Results</h2>
            <span id="elapsed" class="badge bg-secondary d-none"></span>
            <span id="truncated" class="badge bg-warning text-dark d-none">Truncated</span>
          </div>
          <div id="results" class="results-body">
            <div class="text-muted">Run a query to see results here.</div>
          </div>
          <details class="mt-2">
            <summary class="small text-muted">Raw response</summary>
            <pre id="raw" class="mono small mb-0"></pre>
          </details>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script type="module">
    // ✅ Unified bundle from esm.sh – deduplicates all @codemirror deps
    import {
      EditorState,
      EditorView,
      basicSetup
    } from "https://esm.sh/@codemirror/basic-setup@0.20.0?bundle";

    const textarea = document.getElementById("query");
    const editorParent = document.getElementById("editor");

    // Initialize the editor
    const state = EditorState.create({
      doc: textarea.value,
      extensions: [basicSetup],
    });
    const view = new EditorView({ state, parent: editorParent });

    // --- UI logic ---
    const runBtn = document.getElementById("run-btn");
    const formatBtn = document.getElementById("format-btn");
    const resultsEl = document.getElementById("results");
    const rawEl = document.getElementById("raw");
    const elapsedEl = document.getElementById("elapsed");
    const truncEl = document.getElementById("truncated");

    function setLoading(loading) {
      runBtn.disabled = loading;
      runBtn.textContent = loading ? "Running..." : "Run Query";
    }

    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, ch =>
        ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" }[ch]));
    }

    function renderTable(columns, rows) {
      if (!columns?.length) {
        resultsEl.innerHTML = '<div class="alert alert-info">No columns/rows returned.</div>';
        return;
      }
      const thead = `<thead class="table-light"><tr>${columns.map(c => `<th scope="col">${escapeHtml(c)}</th>`).join("")}</tr></thead>`;
      const tbody = `<tbody>${rows.map(r => `<tr>${r.map(cell => `<td>${escapeHtml(String(cell))}</td>`).join("")}</tr>`).join("")}</tbody>`;
      resultsEl.innerHTML = `<div class="table-responsive">
          <table class="table table-sm table-striped align-middle">${thead}${tbody}</table>
        </div>`;
    }

    function setMeta({ elapsed_s, truncated }) {
      if (typeof elapsed_s === "number") {
        elapsedEl.textContent = `Elapsed ${elapsed_s.toFixed(3)}s`;
        elapsedEl.classList.remove("d-none");
      } else {
        elapsedEl.classList.add("d-none");
      }
      if (truncated) truncEl.classList.remove("d-none");
      else truncEl.classList.add("d-none");
    }

    async function runQuery() {
      setLoading(true);
      try {
        const sqlText = view.state.doc.toString();
        const res = await fetch("/api/run_query", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query: sqlText }),
        });
        const payload = await res.json();
        rawEl.textContent = JSON.stringify(payload, null, 2);

        if (payload.error) {
          resultsEl.innerHTML = `
            <div class="alert alert-danger" role="alert">
              <strong>Error:</strong> ${escapeHtml(payload.error.message || String(payload.error))}
            </div>`;
          setMeta({});
          return;
        }

        const result = payload.result || {};
        renderTable(result.columns || [], result.rows || []);
        setMeta({ elapsed_s: result.elapsed_s, truncated: result.truncated });
      } catch (e) {
        resultsEl.innerHTML = `
          <div class="alert alert-danger" role="alert">
            <strong>Network error:</strong> ${escapeHtml(String(e))}
          </div>`;
        setMeta({});
      } finally {
        setLoading(false);
      }
    }

    function formatSql() {
      const txt = view.state.doc.toString().trim();
      const pretty = txt.endsWith(";") ? txt : txt + ";";
      view.dispatch({
        changes: { from: 0, to: view.state.doc.length, insert: pretty + "\n" },
      });
    }

    runBtn.addEventListener("click", runQuery);
    formatBtn.addEventListener("click", formatSql);

    editorParent.addEventListener("keydown", e => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
        e.preventDefault();
        runQuery();
      }
    });
  </script>
{% endblock %}
